name: Build OpenWrt firmware for GL-SFT1200

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        - name: Install dependencies
  run: |
    sudo apt update
    sudo apt install -y \
      build-essential \
      gcc g++ \
      clang \
      flex bison gawk \
      gcc-multilib \
      gettext \
      git \
      libncurses-dev \
      libssl-dev \
      python2 \
      python-is-python2 \
      rsync unzip zlib1g-dev file wget
 python3 python3-distutils rsync unzip zlib1g-dev file wget

    - name: Clone OpenWrt base
      run: |
        git clone https://github.com/openwrt/openwrt.git
        cd openwrt
        git checkout v18.06.9

    - name: Clone SFT1200 target repo
      run: |
        git clone https://github.com/Big7ng/openwrt-sf-sft1200.git sft1200-target

    - name: Merge target
      run: |
        cd openwrt
        cp -r ../sft1200-target/* .
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Create config
      run: |
        cd openwrt
        cat << 'EOF' > .config
        CONFIG_TARGET_siflower=y
        CONFIG_TARGET_siflower_sf19a28=y
        CONFIG_TARGET_siflower_sf19a28_glinet_gl-sft1200=y

        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-i18n-base-ru=y

        CONFIG_PACKAGE_wireguard=y
        CONFIG_PACKAGE_wireguard-tools=y
        CONFIG_PACKAGE_luci-app-wireguard=y

        CONFIG_PACKAGE_openvpn-openssl=y
        CONFIG_PACKAGE_luci-app-openvpn=y

        CONFIG_PACKAGE_dnsmasq-full=y
        CONFIG_PACKAGE_ca-bundle=y
        CONFIG_PACKAGE_ca-certificates=y

        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_nano=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget=y
        EOF

    - name: Prepare config
      run: |
        cd openwrt
        make defconfig FORCE=1

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sft1200-firmware
        path: |
          openwrt/bin/targets/**/*
